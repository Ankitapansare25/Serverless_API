pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = "ap-south-1"    
        S3_BUCKET = "Serverless_buc"  
    }

    stages {

        stage('Checkout') {
            steps {
                git 'https://github.com/Ankitapansare25/Serverless_API.git'
            }
        }

        stage('Zip Lambda') {
            steps {
                sh 'zip -r lambda_function.zip lambda_function.py'
            }
        }

        stage('Upload to S3') {
            steps {
                sh 'aws s3 cp lambda_function.zip s3://${S3_BUCKET}/'
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('terraform') {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Validate API') {
            steps {
                script {
                    // Get API URL from Terraform output
                    def api_url = sh(
                        script: "cd terraform && terraform output -raw api_url",
                        returnStdout: true
                    ).trim()

                    // Test GET request
                    sh "curl -X GET ${api_url}"

                    // Test POST request
                    sh "curl -X POST ${api_url} -H 'Content-Type: application/json' -d '{\"id\":\"1\",\"name\":\"TestItem\"}'"

                    // Test DELETE request
                    sh "curl -X DELETE ${api_url} -H 'Content-Type: application/json' -d '{\"id\":\"1\"}'"
                }
            }
        }

    }

    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed!"
        }
    }
}